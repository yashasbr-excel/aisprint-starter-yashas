---
alwaysApply: true
---

# Vitest Testing Rules

## General Testing Principles

- The purpose of a unit test is to validate that code behaves correctly, not just to make the test pass.
- Do not write placeholder tests that assert `expect(true).toBe(true)` or equivalent. These are not valid tests.
- Only consider a test complete when it verifies meaningful behavior of the target code.
- Each test should run in isolation without depending on other tests.
- Test names should clearly describe what they are verifying.
- Avoid hitting real services or external dependencies in unit tests. Mock external dependencies when necessary.
- Reset mocks between tests to prevent test pollution using `beforeEach(() => { vi.clearAllMocks(); });`.

## Vitest Specific Rules

- Vitest is the chosen testing framework for this project.
- Test files should be colocated with the files they are testing. For example, if `src/utils/format.ts` exists, its test file should be `src/utils/format.test.ts`.
- Use `vi.mock` for mocking modules.
- Use `render` from `@testing-library/react` for testing React components.
- Use `fireEvent` or `userEvent` for simulating user interactions.

## Mocking Patterns

### Server-Only Mock

```typescript
vi.mock("server-only", () => ({}));
```

### Database Mocking

```typescript
// Mock D1 Database for service testing
vi.mock("@/lib/d1-client", () => ({
  executeQuery: vi.fn(),
  executeQueryFirst: vi.fn(),
  executeMutation: vi.fn(),
  executeBatch: vi.fn(),
  generateId: vi.fn(() => "mock-id-123"),
  getDatabase: vi.fn(),
}));
```

## Service Testing Rules

### Test Structure

- Test files should be colocated with the files they are testing
- Mock all external dependencies (database, APIs, etc.) to avoid real service calls
- Test both success and error scenarios
- Verify business logic validation
- Test data type conversions and normalization

### Database Service Testing

- Mock the database interface completely
- Test parameter binding and normalization
- Test error handling and fallback mechanisms
- Verify data transformation logic (e.g., boolean conversion)
- Test user ownership validation
- Test cascade operations and data integrity

### Test Organization

```typescript
describe("ServiceName", () => {
  beforeEach(() => {
    vi.clearAllMocks();
    // Setup fresh mocks for each test
  });

  describe("methodName", () => {
    it("should handle success scenario", () => {
      // Test success path
    });

    it("should handle validation errors", () => {
      // Test business logic validation
    });

    it("should handle database errors", () => {
      // Test error scenarios
    });
  });
});
```
